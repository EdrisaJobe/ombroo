{% extends 'pages/base.html' %}
{% load static %} 
{% block title %}Ombroo | Workspace{% endblock title %} 
{% block css %}<link rel="stylesheet" href="{% static 'css/workspace.css' %}"/>{% endblock css %}

{% block content %}
<div class="main-container">

  <!-- Container 1 -->
  <div class="horizontal-container">
      <p>To Do</p>
  </div>

  <span class="arrow-container">
    <i class="fas fa-arrow-right"></i>
  </span>

  <!-- Container 2 -->
  <div class="horizontal-container">
      <p>In Progress</p>
  </div>

  <span class="arrow-container">
    <i class="fas fa-arrow-right"></i>
  </span>

  <!-- Container 3 -->
  <div class="horizontal-container">
      <p>Testing</p>
  </div>

  <span class="arrow-container">
    <i class="fas fa-arrow-right"></i>
  </span>

  <!-- Container 4 -->
  <div class="horizontal-container">
      <p>Done</p>
  </div>
</div>

<!-- INPUT CONTAINER -->
<div class="input-container">

  <!-- Input Container 1 -->
  <div class="vertical-container">

      <p>Basic Information</p>
      <div class="inside-container">
        <form method="POST" action="{% url 'workspace' %}">
        {% csrf_token %}
          <input type="text" name="task" Placeholder="item description">
          <button type="submit" class="btn-save">✔</button>
        </form>
        
        {% for task in tasks %}
        <form method="POST" action="{% url 'delete_task' forloop.counter0 %}">
          <p class="basic-container" draggable="true" ondragstart="dragStart(event)">
            {% csrf_token %}
            {{ task }} 
            <br>
            <button type="submit" class="btn-del"><i class="far fa-trash-alt"></i></button>
          </p>
        </form>
        {% empty %}
          <br>
          <p>No tasks added yet.</p>
        {% endfor %}
      </div>
  </div>

  <span class="empty-container"></span>
  <span class="arrow-container2">
    <i class="fas fa-arrow-down"></i>
  </span>

  <!-- Input Container 2 -->
  <div class="vertical-container">
      <p>Implementation</p>
      <div class="inside-container" ondragover="allowDrop(event)" ondrop="drop(event)">
        <button class="btn-add">+ Add Grouping</button>
        <p class="implement-container" draggable="true" ondragstart="dragStart(event)">
          Drag and drop items.
        </p>
        <!-- Add a button to clear local storage -->
        <button class="btn-undo" onclick="resetLast()">↩</button>
      </div>
  </div>

  <span class="empty-container"></span>
  <span class="arrow-container2">
    <i class="fas fa-arrow-down"></i>
  </span>

  <!-- Input Container 3 -->
  <div class="vertical-container">
    <p>Testing Stage</p>
    <div class="inside-container" ondragover="allowDrop(event)" ondrop="drop(event)">
      <button class="btn-test">+ Add Grouping</button>
      <p class="testing-container" draggable="true" ondragstart="dragStart(event)"></p>
    </div>
  </div>

  <span class="empty-container"></span>
  <span class="arrow-container2">
    <i class="fas fa-arrow-down"></i>
  </span>

  <!-- Input Container 4 -->
  <div class="vertical-container">
    <p>Completed Task(s)</p>
      <div class="inside-container" ondragover="allowDrop(event)" ondrop="drop(event)">
        <p class="completed-container" draggable="true" ondragstart="dragStart(event)"></p>
      </div>
  </div>

</div>

<!-- DRAG AND DROP SCRIPT -->
<script>
  var draggedElement = null;
  var initialPositions = null;

  function allowDrop(event) {
    event.preventDefault();
  }

  function dragStart(event) {
    draggedElement = event.target;
    event.dataTransfer.setData("text/html", draggedElement.outerHTML);
  }

  function drop(event) {
    event.preventDefault();
    var data = event.dataTransfer.getData("text/html");
    var implementContainer = document.querySelector(".implement-container");
    implementContainer.insertAdjacentHTML("beforeend", data);
    
    if (draggedElement && draggedElement.parentNode) {
      draggedElement.style.display = "none";
      draggedElement = null;
    }

    // Save the new positions to localStorage
    savePositions();
  }

  function savePositions() {
    var implementContainer = document.querySelector(".implement-container");
    var tasks = implementContainer.querySelectorAll(".implement-container > p");
    var positions = [];
    tasks.forEach(function(task) {
      positions.push(task.outerHTML);
    });
    localStorage.setItem("implementPositions", JSON.stringify(positions));
  }

  function loadPositions() {
    var implementContainer = document.querySelector(".implement-container");
    var basicItems = document.querySelectorAll(".basic-container");
    
    // Remove existing items from the "implement-container"
    implementContainer.innerHTML = "";

    var savedPositions = localStorage.getItem("implementPositions");
    if (savedPositions) {
      var positions = JSON.parse(savedPositions);
      implementContainer.innerHTML = positions.join("");

      // Hide corresponding items in the "basic-container"
      positions.forEach(function(position) {
        var itemContent = document.createElement("div");
        itemContent.innerHTML = position;

        basicItems.forEach(function(basicItem) {
          if (basicItem.textContent.trim() === itemContent.textContent.trim()) {
            basicItem.style.display = "none";
          }
        });
      });
    }
  }
  
  // reset the last position of an item
  function resetLast() {
    var implementContainer = document.querySelector(".implement-container");
    var lastItem = implementContainer.lastElementChild;
    if (lastItem) {
      lastItem.parentNode.removeChild(lastItem);
    }

    var basicItems = document.querySelectorAll(".basic-container");
    basicItems.forEach(function(basicItem) {
      if (basicItem.textContent.trim() === lastItem.textContent.trim()) {
        basicItem.style.display = "block";
      }
    });

    // Save the new positions to localStorage
    savePositions();
  }

  // Load positions when the page loads
  window.addEventListener("DOMContentLoaded", function() {
    loadPositions();
  });
</script>
{% endblock content %}
